/* Copyright 2021 Carlos A. (https://github.com/dealfonso); License: http://www.apache.org/licenses/LICENSE-2.0 */
(function(window,document){"use strict";window.powerButtons={version:"0.1.0"};function pascalToSnake(t){return t.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`).replace(/^_*/,"")}function pascalToKebab(t){return t.replace(/[A-Z]/g,t=>`-${t.toLowerCase()}`).replace(/^-*/,"")}function snakeCaseToCamel(t){return t.replace(/-([a-z])/g,t=>t[1].toUpperCase())}function pascalToCamel(t){return t.charAt(0).toLowerCase()+t.slice(1)}function CamelToCamel(t){return t.charAt(0).toUpperCase()+t.slice(1)}function isElement(t){return t instanceof Element||t instanceof HTMLDocument}function flattenobjects(t,...n){let i={};for(let e in t){i[e]=t[e];for(let t=0;t<n.length;t++){if(n[t][e]!==undefined){i[e]=n[t][e]}}}return i}function mergeobjectsr(...t){if(t.length===0){return{}}else if(t.length===1){return t[0]}else{let e={};let n=t[0];if(n===undefined){n={}}let i=t[1];if(i===undefined){i={}}if(n!==undefined){for(let t in n){if(i[t]!==undefined){if(typeof n[t]==="object"&&typeof i[t]==="object"){e[t]=mergeobjectsr(n[t],i[t]);continue}else{e[t]=i[t]}}else{e[t]=n[t]}}}for(let t in i){if(n!==undefined){if(n[t]===undefined){e[t]=i[t]}else{}}}if(t.length===2){return e}else{return mergeobjectsr(e,...t.slice(2))}}}function extractValues(n,i,o="",l={},s=false){let a={};for(let e in n){let t=e;if(l[t]!==undefined){t=l[t]}else{t=o+CamelToCamel(t)}if(i[t]!==undefined){a[e]=i[t]}else{if(s){a[e]=n[e]}}}return a}function parseBoolean(t){if(typeof t==="boolean"){return t}if(typeof t==="string"){t=t.toLowerCase();if(t==="true"||t==="yes"||t==="1"){return true}return false}return!!t}function createTag(t,e={},n=null){let i=t.split("#");let o=null;if(i.length==1){t=i[0]}else{i[1]=i[1].split(".");o=i[1][0];t=[i[0],...i[1].slice(1)].join(".")}let l=t.split(".");t=l[0];if(t===""){t="div"}if(typeof e==="string"){n=e;e={}}if(n!==null){e.innerHTML=n}if(o!==null){e.id=o}e.className=[e.className,...l.slice(1)].filter(function(t){return`${t}`.trim()!==""}).join(" ");let s=document.createElement(t);for(let t in e){if(s[t]!==undefined){s[t]=e[t]}else{s.setAttribute(t,e[t])}}return s}function appendToElement(t,...e){let n=e.filter(t=>t!==null&&t!==undefined);t.append(...n);return t}function searchForm(t){let e=null;if(t!==null){e=document.forms[t];if(e===undefined){e=document.querySelector(settings.form);if(e===null){console.warn(`form ${t} not found`)}}}if(e!==null){if(e.tagName.toLowerCase()!=="form"){console.warn(`form ${t} is not a form`)}}return e}function getValueWithJavascriptSupport(value,context=null){let internalValue=value.trim();if(internalValue.startsWith("javascript:")){try{let f=internalValue.substring(11);value=function(){return eval(f)}.bind(context)()}catch(e){console.error(`Error executing javascript code ${internalValue.substring(11)}, error: ${e}`);value=null}}return value}class DialogLegacy{DEFAULTS={message:"Main message",buttonCount:2};constructor(t={},e=null,n=null){this.options={...this.DEFAULTS,...t};this.buttonCount=this.options.buttons.length;this.options.buttons=["Accept","Cancel"];this.result=null;this.onButton=e;this.onHidden=n}dispose(){}show(t=null,e=null){if(t!==null){this.onButton=t}if(e!==null){this.onHidden=e}switch(this.buttonCount){case 0:case 1:alert(this.message);this.result=0;break;case 2:this.result=confirm(this.options.message)?0:1;break;default:throw`Unsupported button count ${this.buttonCount}`}if(this.onButton!==null){this.onButton(this.result,{button:this.result,text:this.options.buttons[this.result]},null)}if(this.onHidden!==null){this.onHidden(this.result,{button:this.result,text:this.options.buttons[this.result]},null)}}}class Dialog{static create(t={},e=null,n=null){if(window.bootstrap===undefined||window.bootstrap.Modal===undefined){return new DialogLegacy(t,e,n)}if(t.selector!==undefined&&t.selector!==null||t.dialogFunction!==undefined&&t.dialogFunction!==null){throw new Error("not implemented, yet")}return new Dialog(t,e,n)}DEFAULTS={title:"Title",message:"Main message",customContent:null,buttons:["Accept"],buttonClasses:["btn-primary","btn-secondary"],buttonPanelClasses:["text-end"],escapeKeyCancels:true,header:true,footer:true,body:true,close:true};dialog=null;options=null;modal=null;onButton=null;result=null;onHidden=null;onButton=null;constructor(t={},e=null,n=null){if(window.bootstrap===undefined||window.bootstrap.Modal===undefined){throw new Error("Bootstrap is required to use this class")}this.options={...this.DEFAULTS,...t};let i=[];for(let e=0;e<this.options.buttons.length;e++){let t=this.options.buttons[e];if(typeof t==="string"){t={text:t}}else{if(t.text===undefined){t.text=`Button ${e}`}}if(t.class===undefined){t.class=this.options.buttonClasses[Math.min(e,this.options.buttonClasses.length-1)]}i.push(t)}this.options.buttons=i;this.dialog=null;this.modal=null;this.result=null;this.onButton=e;this.onHidden=n;this._hiddenHandler=this._hiddenHandler.bind(this)}_hiddenHandler(){this.dialog.removeEventListener("hidden.bs.modal",this._hiddenHandler);if(this.onHidden!==null){if(this.result!==null&&this.result>=0){this.onHidden(this.result,{button:this.result,text:this.options.buttons[this.result]})}else{this.onHidden(this.result,null)}}}dispose(){if(this.modal!==null){this.modal.dispose();this.modal=null}this.dialog.remove();this.dialog=null}show(t=null,e=null){if(this.dialog===null){this.dialog=this._build_dialog(this.options)}if(this.modal===null){this.modal=new bootstrap.Modal(this.dialog,{backdrop:this.options.escapeKeyCancels?true:"static",keyboard:this.options.escapeKeyCancels})}this.dialog.addEventListener("hidden.bs.modal",this._hiddenHandler);this.result=null;if(t!==null){this.onButton=t}if(e!==null){this.onHidden=e}this.modal.show()}hide(){this.modal.hide()}_handleButton(t,e,n){this.result=t;let i=true;if(this.onButton!==null){i=!(this.onButton(t,e,n)===false)}if(i){this.hide()}}_build_dialog(o={}){let t=null;let e=null;if(parseBoolean(o.close)){e=createTag("button.close.btn-close",{type:"button","aria-label":"Close"});e.addEventListener("click",()=>this._handleButton(-1,null,e))}if(parseBoolean(o.header)){t=createTag(".modal-header");if(o.title!==null){t.append(appendToElement(createTag(".modal-title"),appendToElement(createTag("h5",o.title))))}if(parseBoolean(o.close)){t.append(e)}}let l=[];if(o.buttons!==null){for(let i=0;i<o.buttons.length;i++){let t=o.buttons[i];let e=t.class.split(" ").map(t=>t.trim()).filter(t=>t!=="").join(".");if(o.footer===false){e+=".mx-1"}if(e!==""){e="."+e}let n=createTag("button.btn"+e+".button"+i,{type:"button"},t.text);n.addEventListener("click",function(){this._handleButton(i,t,n);if(t.handler!==undefined&&t.handler!==null){t.handler(i,t,n)}}.bind(this));l.push(n)}}let n=null;if(parseBoolean(o.footer)){n=appendToElement(createTag(".modal-footer"),...l)}let i=null;if(parseBoolean(o.body)){i=createTag(".modal-body");if(t===null){if(parseBoolean(o.close)){i.append(appendToElement(createTag(".text-end"),e))}}if(o.message!==null){i.append(createTag("p.message.text-center",o.message))}if(o.customContent!==null){i.append(createTag(".custom-content.mx-auto",o.customContent))}if(n===null){let t=o.buttonPanelClasses.map(t=>t.trim()).filter(t=>t!=="").join(".");if(t!==""){t="."+t}appendToElement(i,appendToElement(createTag(".buttons"+t),...l))}}let s=appendToElement(createTag(".modal.fade",{tabindex:"-1",role:"dialog","aria-hidden":"true","data-keyboard":"false"}),appendToElement(createTag(".modal-dialog.modal-dialog-centered",{role:"document"}),appendToElement(createTag(".modal-content"),t,i,n)));return s}}function confirmDialog(t,e="this action needs confirmation",n=null,i=null,o=true){let l=new Dialog({title:e,message:t,buttons:[{text:"Cancel",class:"btn-secondary",handler:i},{text:"Confirm",class:"btn-primary",handler:n}],escapeKeyCancels:o});l.show();return l}function alertDialog(t,e="Alert",n=null){let i=new Dialog({title:e,message:t,buttons:[{text:"Accept",class:"btn-primary",handler:n}],escapeKeyCancels:true});i.show();return i}function loadingDialog(t,e=null,n=null){if(typeof e==="function"){n=e;e=null}let i=new Dialog({title:null,message:t,buttons:[{text:"Cancel",class:"btn-primary"}],customContent:e,escapeKeyCancels:false,close:false,header:false,footer:false},n);i.show();return i}window.powerButtons=mergeobjectsr(window.powerButtons,{utils:{confirmDialog:confirmDialog,alertDialog:alertDialog,loadingDialog:loadingDialog}});class PowerButtons{static actionsRegistered={};static registerAction(t){console.debug(`Registering action ${t.NAME}`);this.actionsRegistered[t.NAME]=t;let e={};e[`defaults${t.NAME}`]=t.DEFAULTS;window.powerButtons=mergeobjectsr(window.powerButtons,{config:e})}static addAction(t,e={}){let n=PowerButtons.addActionSupport(t);n.appendAction(e)}static addActionSupport(t){if(t._powerButtons===undefined){t._powerButtons=new PowerButtons(t)}else{t._powerButtons.reset()}return t._powerButtons}el=null;current_action=0;actions=[];back_onclick=null;constructor(t){t._powerButtons=this;this.el=t;this.current_action=0;this.actions=[];this.back_onclick=null;if(t.onclick!==undefined&&t.onclick!==null){this.back_onclick=t.onclick;t.onclick=null}t.addEventListener("click",this.handlerClick.bind(this))}appendAction(t={}){if(t.type===undefined){throw"The type of the action is mandatory"}this.actions.push(t)}handlerClick(t){if(this.current_action>=this.actions.length){this.current_action=0;if(typeof this.back_onclick==="function"){if(!this.back_onclick()){t.preventDefault()}}return}let e=this.actions[this.current_action];t.preventDefault();t.stopImmediatePropagation();let n=function(){this.current_action++;if(this.current_action>=this.actions.length){if(this.el.click!==undefined){this.el.click()}else{this.el.dispatchEvent(new Event(t.type,t))}}else{this.el.dispatchEvent(new Event(t.type,t))}}.bind(this);let i=this.constructor.actionsRegistered[e.type];if(i===undefined){throw`The action ${e.type} is not registered`}i.execute(e,n,()=>this.reset())}reset(){this.current_action=0}static initializeAll(){Object.entries(this.actionsRegistered).forEach(([t,e])=>{e.initializeAll()})}}function init(t){PowerButtons.initializeAll()}if(document.addEventListener!==undefined){document.addEventListener("DOMContentLoaded",function(t){init(document)})}class Action{static NAME=null;static register(t){PowerButtons.registerAction(this)}static DEFAULTS={};static extractOptions(t,e=null,n=null){if(e===null){e=this.NAME.toLowerCase()}if(n===null){n={};n[e]=e}let i=extractValues(this.DEFAULTS,t.dataset,e,n);return i}static initialize(t,e={},n=null,i=null){let o=this.extractOptions(t,n,i);o.type=this.NAME;PowerButtons.addAction(t,Object.assign({},o,extractValues(this.DEFAULTS,e)))}static initializeAll(e={},n=null,i=null){if(n===null){n=this.NAME.toLowerCase()}for(let t of document.querySelectorAll(`[data-${n}`)){this.initialize(t,e,n,i)}}static execute(t,e,n){throw new Error("The execute method must be implemented by the derived class")}}class ActionConfirm extends Action{static NAME="Confirm";static DEFAULTS={confirm:"Please confirm this action",customContent:null,title:"The action requires confirmation",buttonConfirm:"Confirm",buttonCancel:"Cancel",buttonClose:true,escapeKey:true};static execute(t,e,n){let i=flattenobjects(this.DEFAULTS,window.powerButtons.config.defaultsConfirm,t);let o=Dialog.create({title:i.title,message:i.confirm,customContent:i.customContent,buttons:[i.buttonConfirm,i.buttonCancel],escapeKeyCancels:i.escapeKey,close:i.buttonClose},null,function(t){if(t===0){if(e!==null){e()}}else{if(n!==null){n()}}});o.show()}}ActionConfirm.register();class ActionFormset extends Action{static NAME="Formset";static DEFAULTS={form:null,fields:{}};static extractOptions(n,i=null,t=null){if(i===null){i=this.NAME.toLowerCase()}let e=super.extractOptions(n,i,{form:"formset"});let o={};for(let e in n.dataset){if(e.startsWith(i)){let t=e.substring(i.length);if(t===""){continue}if(t[0]!==t[0].toUpperCase()){continue}t=t.toLocaleLowerCase();o[t]=n.dataset[e]}}e.fields=mergeobjectsr(e.fields,o);return e}static execute(t,e,n){let i=flattenobjects(this.DEFAULTS,window.powerButtons.config.defaultsFormset,t);let o=searchForm(i.form);if(o===null){console.error(`Form not found ${i.form}`);return}let l={};for(var s=0;s<o.elements.length;s++){let t=o.elements[s];if(t.name!==""){l[t.name.toLocaleLowerCase()]=t.name}if(t.id!==""){l[t.id.toLocaleLowerCase()]=t.id}}for(var a in i.fields){if(l[a]!==undefined){let t=i.fields[a];o[l[a]].value=getValueWithJavascriptSupport(t,o)}}e()}}ActionFormset.register();class ActionShowMessage extends Action{static NAME="ShowMessage";static DEFAULTS={showmessage:"This is a message",customContent:null,title:null,buttonAccept:"Accept",escapeKey:true,buttonClose:true,header:true,footer:true};static execute(t,e,n){let i=flattenobjects(this.DEFAULTS,window.powerButtons.config.defaultsShowMessage,t);let o=Dialog.create({title:i.title,message:i.showmessage,customContent:i.customContent,buttons:[i.buttonAccept],escapeKeyCancels:i.escapeKey,close:i.buttonClose,header:t.header!==undefined?i.header:i.title!==null&&i.title!="",footer:t.footer!==undefined?i.footer:i.buttonAccept!==null&&i.buttonAccept!=""},null,function(t){if(e!==null){e()}});o.show()}}ActionShowMessage.register();class ActionVerify extends Action{static NAME="Verify";static DEFAULTS={verify:null,form:null,verified:null,notVerified:"The condition for this action is not met",customContentVerified:null,customContentNotVerified:null,titleNotVerified:"The action requires verification",titleVerified:null,buttonAccept:"Accept",buttonClose:false,escapeKey:true,header:true,footer:true};static execute(options,onNextAction,onCancelActions){let settings=flattenobjects(this.DEFAULTS,window.powerButtons.config.defaultsVerify,options);let result=null;let bindObject=searchForm(settings.form);if(bindObject===null){bindObject=document}try{if(typeof settings.verify==="function"){result=settings.verify.bind(bindObject)()}else if(typeof settings.verify==="string"){result=function(){return eval(settings.verify)}.bind(bindObject)()}else{result=parseBoolean(settings.verify)}}catch(e){console.error("Error executing verification function",e);result=false}let dialog=null;let onVerificationSuccess=onNextAction;let onVerificationFailure=onCancelActions;if(result){if(settings.verified!==null||settings.customContentVerified!==null||settings.titleVerified!==null){dialog=Dialog.create({title:settings.titleVerified,message:settings.verified,customContent:settings.customContentVerified,buttons:[settings.buttonAccept],escapeKeyCancels:settings.escapeKey,close:settings.buttonClose},null,function(t){if(onVerificationSuccess!==null){onVerificationSuccess()}})}}else{if(settings.notVerified!==null||settings.customContentNotVerified!==null||settings.titleNotVerified!==null){dialog=Dialog.create({title:settings.titleNotVerified,message:settings.notVerified,customContent:settings.customContentNotVerified,buttons:[settings.buttonAccept],escapeKeyCancels:settings.escapeKey,close:settings.buttonClose},null,function(t){if(onVerificationFailure!==null){onVerificationFailure()}})}}if(dialog!==null){dialog.show()}else{if(result){if(onVerificationSuccess!==null){onVerificationSuccess()}}else{if(onVerificationFailure!==null){onVerificationFailure()}}}}}ActionVerify.register()})(window,document);
